<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Viewer Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-color: #0e0e10;
            --surface-color: #18181b;
            --surface-hover: #1f1f23;
            --accent-color: #9146ff;
            --accent-hover: #772ce8;
            --text-primary: #efeff1;
            --text-secondary: #adadb8;
            --danger-color: #e91916;
            --danger-hover: #c20e0c;
            --success-color: #00f593;
            --warning-color: #ff9900;

            --glass-bg: rgba(24, 24, 27, 0.6);
            --glass-border: rgba(255, 255, 255, 0.05);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 2rem;
            line-height: 1.5;
        }

        h1 {
            font-family: 'Outfit', sans-serif;
            font-size: 2rem;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, #ffffff 0%, var(--accent-color) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            width: fit-content;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .dashboard-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            animation: fadeIn 0.5s ease-out;
        }

        .table-container {
            width: 100%;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
            font-size: 0.875rem;
        }

        thead th {
            background-color: rgba(0, 0, 0, 0.2);
            padding: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.75rem;
            border-bottom: 1px solid var(--glass-border);
            white-space: nowrap;
        }

        tbody tr {
            border-bottom: 1px solid var(--glass-border);
            transition: background-color 0.2s;
        }

        tbody tr:last-child {
            border-bottom: none;
        }

        tbody tr:hover {
            background-color: var(--surface-hover);
        }

        td {
            padding: 1rem;
            vertical-align: middle;
            color: var(--text-primary);
            white-space: nowrap;
        }

        /* User Info */
        .user-cell {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .user-search {
            margin-bottom: 1.5rem;
            display: flex;
            gap: 1rem;
        }

        .search-input {
            background: var(--surface-color);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            width: 300px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 600;
            line-height: 1;
        }

        .badge-sub-t1 {
            background: rgba(145, 70, 255, 0.15);
            color: #bf94ff;
            border: 1px solid rgba(145, 70, 255, 0.2);
        }

        .badge-sub-t2 {
            background: rgba(0, 245, 147, 0.15);
            color: #00f593;
            border: 1px solid rgba(0, 245, 147, 0.2);
        }

        .badge-sub-t3 {
            background: rgba(255, 153, 0, 0.15);
            color: #ff9900;
            border: 1px solid rgba(255, 153, 0, 0.2);
        }

        .badge-none {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
        }

        /* Actions */
        .actions-cell {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            appearance: none;
            background: transparent;
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-timeout {
            color: var(--warning-color);
            border-color: rgba(255, 153, 0, 0.2);
            background: rgba(255, 153, 0, 0.05);
        }

        .btn-timeout:hover {
            background: rgba(255, 153, 0, 0.15);
        }

        .btn-untimeout {
            color: var(--text-secondary);
        }

        .btn-untimeout:hover {
            background: var(--surface-hover);
            color: var(--text-primary);
        }

        .btn-ban {
            color: var(--danger-color);
            border-color: rgba(233, 25, 22, 0.2);
            background: rgba(233, 25, 22, 0.05);
        }

        .btn-ban:hover {
            background: rgba(233, 25, 22, 0.15);
        }

        .btn-unban {
            color: var(--text-secondary);
        }

        .btn-unban:hover {
            background: var(--surface-hover);
            color: var(--text-primary);
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--surface-hover);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--accent-color);
            font-size: 12px;
            border: 1px solid var(--glass-border);
        }

        /* Login UI */
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 60vh;
            text-align: center;
            gap: 2rem;
        }

        .btn-twitch {
            background-color: #9146ff;
            color: white;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-twitch:hover {
            background-color: #772ce8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(145, 70, 255, 0.3);
        }

        .btn-disconnect {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            margin-left: auto;
        }

        .btn-disconnect:hover {
            background-color: rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
        }

        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .hidden {
            display: none !important;
        }

        .user-link {
            color: var(--text-primary);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }

        .user-link:hover {
            color: var(--accent-color);
            text-decoration: underline;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-color);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--surface-hover);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #2a2a30;
        }

        .notification {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md);
            background: var(--surface-color);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            box-shadow: var(--shadow-lg);
            transform: translateY(150%);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.875rem;
        }

        .notification.show {
            transform: translateY(0);
        }

        .notification.success {
            border-left: 4px solid var(--success-color);
        }

        .notification.error {
            border-left: 4px solid var(--danger-color);
        }
    </style>
</head>

<body>

    <div class="container">
        <!-- Login View -->
        <div id="loginView" class="login-container">
            <h1>Twitch Viewer Dashboard</h1>
            <p style="color: var(--text-secondary); max-width: 500px; margin-bottom: 2rem;">
                自身の配信の視聴者を管理・一覧表示するためのダッシュボードです。<br>
                利用するにはTwitchアカウントでログインしてください。
                自身の配信の視聴者を管理・一覧表示するためのダッシュボードです。<br>
                利用するにはTwitchアカウントでログインしてください。
            </p>

            <div style="margin-bottom: 2rem; width: 100%; max-width: 400px; text-align: left;">
                <label for="clientIdInput"
                    style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">Client
                    ID</label>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="clientIdInput" class="search-input" placeholder="Twitch Client IDを入力"
                        style="width: 100%;">
                </div>
                <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">
                    <a href="https://dev.twitch.tv/console/apps" target="_blank"
                        style="color: var(--accent-color); text-decoration: none;">Twitch Developer Console</a>
                    でIDを取得してください。
                </p>
            </div>

            <button id="loginBtn" class="btn btn-twitch">
                <svg width="20" height="20" viewBox="0 0 21 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M13.8571 5.45455H15.1429V10.9091H13.8571V5.45455ZM9.35714 5.45455H10.6429V10.9091H9.35714V5.45455ZM4.21429 0L0.357143 3.81818V19.0909H5.5V24L10 19.0909H13.2143L20.2857 12V0H4.21429ZM18.3571 11.4545L15.1429 14.7273H10.6429L8.07143 17.4545V14.7273H5.5V1.63636H18.3571V11.4545Z"
                        fill="white" />
                </svg>
                Twitchで接続
            </button>
        </div>

        <!-- Dashboard View -->
        <div id="dashboardView" class="hidden">
            <div class="header-actions">
                <h1>Viewer Dashboard</h1>
                <button id="disconnectBtn" class="btn btn-disconnect">切断</button>
            </div>

            <div class="user-search">
                <input type="text" id="searchInput" class="search-input" placeholder="視聴者を検索...">
            </div>

            <div class="dashboard-card">
                <div class="table-container">
                    <table id="viewerTable">
                        <thead>
                            <tr>
                                <th>表示名</th>
                                <th>サブスク種別</th>
                                <th>入室時間</th>
                                <th>経過時間</th>
                                <th>タイムアウト</th>
                                <th>BAN</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div> <!-- End Dashboard View -->
    </div>

    <div id="notification" class="notification">
        <span id="notifMessage">Message</span>
    </div>

    <script>
        // Mock Data
        const viewers = [
            { id: '12345678', name: 'CoolGamer99', subTier: 'Tier 1', joinTime: new Date(new Date().getTime() - 1000 * 60 * 15) },
            { id: '87654321', name: 'TwitchFan_JP', subTier: 'None', joinTime: new Date(new Date().getTime() - 1000 * 60 * 5) },
            { id: '11223344', name: 'ProStreamerWatch', subTier: 'Tier 3', joinTime: new Date(new Date().getTime() - 1000 * 60 * 120) },
            { id: '44332211', name: 'NewbieUser', subTier: 'None', joinTime: new Date(new Date().getTime() - 1000 * 30) },
            { id: '55667788', name: 'Mod_Alpha', subTier: 'Tier 2', joinTime: new Date(new Date().getTime() - 1000 * 60 * 45) },
            { id: '99887766', name: 'LurkerBot', subTier: 'None', joinTime: new Date(new Date().getTime() - 1000 * 60 * 300) },
        ];

        // State for mock actions
        const actionState = {}; // { userId: { timedOut: bool, banned: bool } }

        viewers.forEach(v => {
            actionState[v.id] = { timedOut: false, banned: false };
        });

        function formatTime(date) {
            return date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
        }

        function formatDuration(date) {
            const now = new Date();
            const diff = now - date;

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            if (hours > 0) return `${hours}時間 ${minutes}分`;
            return `${minutes}分 ${seconds}秒`;
        }

        function getSubBadgeClass(tier) {
            if (tier.includes('1')) return 'badge-sub-t1';
            if (tier.includes('2')) return 'badge-sub-t2';
            if (tier.includes('3')) return 'badge-sub-t3';
            return 'badge-none';
        }

        function getAvatarInitials(name) {
            return name.substring(0, 2).toUpperCase();
        }

        function renderTable() {
            const tbody = document.querySelector('#viewerTable tbody');
            const searchText = document.getElementById('searchInput').value.toLowerCase();

            tbody.innerHTML = '';

            const filteredViewers = viewers.filter(v =>
                v.name.toLowerCase().includes(searchText) ||
                v.id.includes(searchText)
            );

            filteredViewers.forEach(viewer => {
                const tr = document.createElement('tr');
                const state = actionState[viewer.id];

                tr.innerHTML = `
                    <td>
                        <div class="user-cell">
                            <div class="avatar">${getAvatarInitials(viewer.name)}</div>
                            <a href="https://www.twitch.tv/${viewer.name}" target="_blank" class="user-link">${viewer.name}</a>
                        </div>
                    </td>
                    <td>
                        <span class="badge ${getSubBadgeClass(viewer.subTier)}">${viewer.subTier}</span>
                    </td>
                    <td style="color: var(--text-secondary);">${formatTime(viewer.joinTime)}</td>
                    <td class="duration-cell" data-time="${viewer.joinTime.getTime()}" style="font-variant-numeric: tabular-nums;">
                        ${formatDuration(viewer.joinTime)}
                    </td>
                    <td>
                        <div class="actions-cell">
                            ${!state.timedOut
                        ? `<button class="btn btn-timeout" onclick="handleTimeout('${viewer.id}', true)">実行</button>`
                        : `<button class="btn btn-untimeout" onclick="handleTimeout('${viewer.id}', false)">解除</button>`
                    }
                        </div>
                    </td>
                    <td>
                        <div class="actions-cell">
                            ${!state.banned
                        ? `<button class="btn btn-ban" onclick="handleBan('${viewer.id}', true)">実行</button>`
                        : `<button class="btn btn-unban" onclick="handleBan('${viewer.id}', false)">解除</button>`
                    }
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Actions
        window.handleTimeout = (id, isExecute) => {
            const user = viewers.find(v => v.id === id);
            actionState[id].timedOut = isExecute;
            showNotification(isExecute
                ? `${user.name} をタイムアウトしました`
                : `${user.name} のタイムアウトを解除しました`, 'success');
            renderTable();
        };

        window.handleBan = (id, isExecute) => {
            const user = viewers.find(v => v.id === id);
            actionState[id].banned = isExecute;
            showNotification(isExecute
                ? `${user.name} をBANしました`
                : `${user.name} のBANを解除しました`, isExecute ? 'error' : 'success');
            renderTable();
        };

        // Notifications
        function showNotification(msg, type) {
            const el = document.getElementById('notification');
            const msgEl = document.getElementById('notifMessage');

            el.className = `notification ${type}`;
            msgEl.textContent = msg;

            el.classList.add('show');

            setTimeout(() => {
                el.classList.remove('show');
            }, 3000);
        }

        // Initial Render
        // renderTable(); // Called after data fetch in future
        initAuth();

        // Event Listeners
        document.getElementById('loginBtn').addEventListener('click', login);
        document.getElementById('disconnectBtn').addEventListener('click', logout);
        setInterval(() => {
            document.querySelectorAll('.duration-cell').forEach(cell => {
                const time = parseInt(cell.getAttribute('data-time'));
                cell.textContent = formatDuration(new Date(time));
            });
        }, 1000);

        // Search Listener
        document.getElementById('searchInput').addEventListener('input', renderTable);

    </script>
</body>

</html>